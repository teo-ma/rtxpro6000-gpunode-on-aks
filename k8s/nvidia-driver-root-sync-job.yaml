apiVersion: batch/v1
kind: Job
metadata:
  name: nvidia-driver-root-sync
  namespace: gpu-operator
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 600
  template:
    spec:
      restartPolicy: Never
      hostPID: true
      nodeSelector:
        agentpool: rtxpro6000
      tolerations:
      - key: "sku"
        operator: "Equal"
        value: "gpu"
        effect: "NoSchedule"
      containers:
      - name: sync
        image: ubuntu:22.04
        securityContext:
          privileged: true
        command:
        - sh
        - -c
        - |
          set -eux

          mkdir -p /run/nvidia/driver/usr/bin
          mkdir -p /run/nvidia/driver/usr/lib/x86_64-linux-gnu
              mkdir -p /run/nvidia/driver/sbin
          mkdir -p /run/nvidia/driver/etc

          # Copy key binaries that validations/tooling may expect under driver root
          if [ -x /host/usr/bin/nvidia-smi ]; then
                cp -af /host/usr/bin/nvidia-smi /run/nvidia/driver/usr/bin/nvidia-smi
          fi
              # Some images/driver roots may already have ldconfig as a file/dir/symlink.
              # We don't strictly need it for the sync job itself; use best-effort logic.
              if [ -e /run/nvidia/driver/sbin/ldconfig ]; then
                rm -rf /run/nvidia/driver/sbin/ldconfig || true
              fi
              if [ -x /host/sbin/ldconfig ]; then
                cp -af /host/sbin/ldconfig /run/nvidia/driver/sbin/ldconfig || true
              fi

          # Copy NVIDIA user-space libraries into driver root
          # (GPU Operator components expect these under /run/nvidia/driver)
          cp -a /host/usr/lib/x86_64-linux-gnu/libcuda.so* /run/nvidia/driver/usr/lib/x86_64-linux-gnu/ || true
          cp -a /host/usr/lib/x86_64-linux-gnu/libnvidia-*.so* /run/nvidia/driver/usr/lib/x86_64-linux-gnu/ || true

          # Rebuild ld.so cache for the driver root (best-effort)
          if [ -x /host/sbin/ldconfig ]; then
            /host/sbin/ldconfig -r /run/nvidia/driver || true
          fi

          ls -la /run/nvidia/driver/usr/bin || true
          ls -la /run/nvidia/driver/usr/lib/x86_64-linux-gnu | head -n 50 || true
          echo "driver-root sync done"
        volumeMounts:
        - name: host-root
          mountPath: /host
          readOnly: true
        - name: driver-install-dir
          mountPath: /run/nvidia/driver
      volumes:
      - name: host-root
        hostPath:
          path: /
          type: Directory
      - name: driver-install-dir
        hostPath:
          path: /run/nvidia/driver
          type: DirectoryOrCreate
